<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcade Core - Image Cache Test</title>
    <script src="arcadeHud.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-width: 600px;
            max-width: 800px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }

        .section-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            font-size: 18px;
        }

        .test-button {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(68, 160, 141, 0.3);
            margin: 10px;
        }

        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(68, 160, 141, 0.4);
        }

        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .url-display {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            text-align: left;
        }

        .status {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            min-height: 20px;
        }

        .status.loading {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .image-preview {
            margin: 20px 0;
            border: 2px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            display: none;
        }

        .image-preview img {
            max-width: 100%;
            height: auto;
            display: block;
        }

        .test-urls {
            text-align: left;
            margin: 20px 0;
        }

        .test-urls h4 {
            margin-bottom: 10px;
            color: #333;
        }

        .test-urls li {
            margin: 5px 0;
            font-size: 14px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
        }

        .custom-url {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            margin: 10px 0;
        }

        .custom-url:focus {
            outline: none;
            border-color: #667eea;
        }

        .info-text {
            text-align: left;
            font-size: 14px;
            line-height: 1.6;
            color: #555;
        }

        .info-text code {
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .info-text ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .info-text ul li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñºÔ∏è Image Cache Test</h1>
        <p class="subtitle">Test the getCacheImage functionality with aspect ratio preservation and automatic cropping</p>

        <div class="test-section">
            <div class="section-title">How It Works</div>
            <div class="info-text">
                <p><strong>Aspect Ratio Preservation:</strong></p>
                <ul>
                    <li>Images are rendered in a 512x512 offscreen view</li>
                    <li>CSS <code>object-fit: contain</code> maintains original aspect ratio</li>
                    <li>JavaScript calculates the actual rendered image bounds using <code>getBoundingClientRect()</code></li>
                    <li>C++ crops the bitmap to save only the actual image pixels (no transparent borders)</li>
                </ul>
                <p style="margin-top: 15px;"><strong>Result:</strong> Cached PNG files match the original aspect ratio with no wasted transparent pixels.</p>
            </div>
        </div>

        <div class="test-section">
            <div class="section-title">Default Test URL</div>
            <div class="url-display" id="defaultUrl">https://img.youtube.com/vi/PVF9lZ-i_ss/0.jpg</div>
            <button id="testDefaultBtn" class="test-button" onclick="testDefaultImage()">
                Cache Default Image
            </button>
        </div>

        <div class="test-section">
            <div class="section-title">Custom URL Test</div>
            <input type="text" id="customUrl" class="custom-url"
                   placeholder="Enter any image URL to test..."
                   value="https://picsum.photos/400/300">
            <br>
            <button id="testCustomBtn" class="test-button" onclick="testCustomImage()">
                Cache Custom Image
            </button>
        </div>

        <div class="test-section">
            <div class="section-title">Quick Test URLs</div>
            <div class="test-urls">
                <h4>Click any URL to test (various aspect ratios):</h4>
                <ul>
                    <li><a href="#" onclick="testUrl('https://picsum.photos/800/600')">https://picsum.photos/800/600</a> (4:3 landscape)</li>
                    <li><a href="#" onclick="testUrl('https://picsum.photos/300/400')">https://picsum.photos/300/400</a> (3:4 portrait)</li>
                    <li><a href="#" onclick="testUrl('https://httpbin.org/image/png')">https://httpbin.org/image/png</a> (square)</li>
                    <li><a href="#" onclick="testUrl('https://via.placeholder.com/800x200.png')">https://via.placeholder.com/800x200.png</a> (wide banner)</li>
                </ul>
            </div>
        </div>

        <div id="status" class="status">Ready to test image caching</div>

        <div id="imagePreview" class="image-preview">
            <img id="cachedImage" alt="Cached Image" />
        </div>

        <div class="test-section">
            <div class="section-title">Test Results</div>
            <div class="url-display" id="resultUrl">File URL will appear here after successful caching</div>
            <div class="url-display" id="resultDownloader" style="margin-top: 10px; display: none;">
                <strong>Image Loader:</strong> <span id="downloaderName"></span>
            </div>
            <div class="info-text" id="resultInfo" style="margin-top: 10px; display: none; padding: 10px; background: #e7f3ff; border-radius: 5px;">
                <strong>Note:</strong> The cached image has been automatically cropped to remove transparent borders while preserving the original aspect ratio.
                The rendered rect coordinates are used internally for cropping but are not currently exposed through the JavaScript API.
            </div>
        </div>
    </div>

    <script>
        function updateStatus(message, type = 'loading') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function showResult(fileUrl, downloaderName) {
            const resultDiv = document.getElementById('resultUrl');
            const downloaderDiv = document.getElementById('resultDownloader');
            const downloaderNameSpan = document.getElementById('downloaderName');
            const resultInfo = document.getElementById('resultInfo');
            const imagePreview = document.getElementById('imagePreview');
            const cachedImage = document.getElementById('cachedImage');

            resultDiv.textContent = fileUrl;
            downloaderNameSpan.textContent = downloaderName || 'ImageLoader';
            downloaderDiv.style.display = 'block';
            resultInfo.style.display = 'block';
            cachedImage.src = fileUrl;
            imagePreview.style.display = 'block';
        }

        function hideResult() {
            const resultDiv = document.getElementById('resultUrl');
            const downloaderDiv = document.getElementById('resultDownloader');
            const resultInfo = document.getElementById('resultInfo');
            const imagePreview = document.getElementById('imagePreview');

            resultDiv.textContent = 'File URL will appear here after successful caching';
            downloaderDiv.style.display = 'none';
            resultInfo.style.display = 'none';
            imagePreview.style.display = 'none';
        }

        function setButtonsEnabled(enabled) {
            document.getElementById('testDefaultBtn').disabled = !enabled;
            document.getElementById('testCustomBtn').disabled = !enabled;
        }

        function testImage(url) {
            hideResult();
            setButtonsEnabled(false);
            updateStatus(`üîÑ Loading and caching image with aspect ratio preservation...`, 'loading');

            console.log('Testing image cache for URL:', url);

            // Use arcadeHud for simplified API
            arcadeHud.loadImage(url)
                .then(result => {
                    console.log('Image cached successfully:', result);
                    updateStatus(`‚úÖ Image cached with aspect ratio preserved!`, 'success');

                    // Note: rect info (rectX, rectY, rectWidth, rectHeight) is used
                    // internally for cropping but not exposed through the Promise.
                    // The saved PNG is already cropped to the actual image dimensions.
                    showResult(result.filePath, result.downloaderName);
                    setButtonsEnabled(true);
                })
                .catch(error => {
                    console.error('Image caching failed:', error);
                    updateStatus(`‚ùå Caching failed: ${error}`, 'error');
                    setButtonsEnabled(true);
                });
        }

        function testDefaultImage() {
            const defaultUrl = document.getElementById('defaultUrl').textContent;
            testImage(defaultUrl);
        }

        function testCustomImage() {
            const customUrl = document.getElementById('customUrl').value.trim();
            if (!customUrl) {
                updateStatus('‚ùå Please enter a URL to test', 'error');
                return;
            }
            testImage(customUrl);
        }

        function testUrl(url) {
            document.getElementById('customUrl').value = url;
            testImage(url);
        }

        // Test arcadeHud availability on page load
        window.addEventListener('load', function() {
            console.log('Image cache test page loaded');

            if (!arcadeHud.isReady()) {
                updateStatus('‚ö†Ô∏è Warning: arcadeHud not initialized. Make sure this page is loaded in Arcade Core.', 'error');
            } else if (!arcadeHud.hasFeature('imageCache')) {
                updateStatus('‚ö†Ô∏è Warning: Image caching not available.', 'error');
            } else {
                updateStatus('üü¢ Ready to test image caching with aspect ratio preservation!', 'success');
            }
        });
    </script>
</body>
</html>
